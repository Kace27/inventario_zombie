{% extends "layout.html" %}

{% block title %}Importar Ventas - Inventario Zombie{% endblock %}

{% block head %}
<style>
    .import-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .file-upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        transition: all 0.3s;
    }
    .file-upload-area:hover {
        border-color: #888;
    }
    .file-upload-area.active {
        border-color: #4CAF50;
        background-color: rgba(76, 175, 80, 0.1);
    }
    .status-container {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        display: none;
    }
    .status-success {
        background-color: rgba(76, 175, 80, 0.1);
        border: 1px solid #4CAF50;
    }
    .status-error {
        background-color: rgba(244, 67, 54, 0.1);
        border: 1px solid #F44336;
    }
    .preview-container {
        margin-top: 20px;
        overflow-x: auto;
    }
    .preview-table {
        width: 100%;
        border-collapse: collapse;
    }
    .preview-table th, .preview-table td {
        padding: 8px;
        border: 1px solid #ddd;
    }
    .preview-table th {
        background-color: #f2f2f2;
    }
    .format-info {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .format-info h3 {
        margin-top: 0;
    }
    .form-actions {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="import-container">
    <h1>Importar Datos de Ventas</h1>
    
    <div class="format-info">
        <h3>Formato Esperado del CSV</h3>
        <p>El archivo CSV debe tener las siguientes columnas en este orden exacto:</p>
        <p><code>Artículo,REF,Categoria,Articulos vendidos,Ventas brutas,Articulos reembolsados,Reembolsos,Descuentos,Ventas netas,Costo de los bienes,Beneficio bruto,Margen,Impuestos</code></p>
        <p>Por ejemplo:</p>
        <p><code>Agua,10037,Sin categoria,5.000,125.00,0.000,0.00,3.62,121.38,0.00,121.38,100.00%,0.00</code></p>
    </div>
    
    <div class="file-upload-area" id="dropZone">
        <p><i class="fas fa-file-csv fa-3x"></i></p>
        <p>Arrastra y suelta un archivo CSV o haz clic para seleccionarlo</p>
        <input type="file" id="fileInput" accept=".csv" style="display: none;">
        <button id="browseButton" class="btn">Seleccionar archivo</button>
    </div>
    
    <div id="fileInfo" style="display: none;">
        <p>Archivo seleccionado: <span id="fileName"></span></p>
        <div class="form-actions">
            <button id="importButton" class="btn btn-primary">Importar datos</button>
            <button id="changeFileButton" class="btn btn-secondary">Cambiar archivo</button>
        </div>
    </div>
    
    <div id="previewContainer" class="preview-container" style="display: none;">
        <h2>Vista previa de los datos</h2>
        <div id="previewTable"></div>
    </div>
    
    <div id="statusContainer" class="status-container">
        <h3 id="statusTitle"></h3>
        <p id="statusMessage"></p>
        <div id="statusDetails"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const browseButton = document.getElementById('browseButton');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const changeFileButton = document.getElementById('changeFileButton');
        const importButton = document.getElementById('importButton');
        const statusContainer = document.getElementById('statusContainer');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const statusDetails = document.getElementById('statusDetails');
        const previewContainer = document.getElementById('previewContainer');
        const previewTable = document.getElementById('previewTable');
        
        let csvFile = null;
        let csvHeaders = [];
        let csvData = [];
        
        // Handle click on browse button
        browseButton.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', handleFileSelect);
        
        // Handle drag and drop
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('active');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('active');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('active');
            
            const dt = e.dataTransfer;
            const files = dt.files;
            
            fileInput.files = files;
            handleFileSelect(e);
        });
        
        // Handle change file button
        changeFileButton.addEventListener('click', function() {
            resetUI();
        });
        
        // Handle import button
        importButton.addEventListener('click', importData);
        
        // Function to handle file selection
        function handleFileSelect(e) {
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                showStatus('error', 'Error de archivo', 'Por favor, selecciona un archivo CSV válido.');
                return;
            }
            
            csvFile = file;
            fileName.textContent = file.name;
            
            dropZone.style.display = 'none';
            fileInfo.style.display = 'block';
            
            parseCSV(file);
        }
        
        // Function to parse CSV file
        function parseCSV(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const contents = e.target.result;
                const lines = contents.split('\n');
                
                // Extract headers
                const headerLine = lines[0];
                csvHeaders = headerLine.split(',').map(header => header.trim());
                
                // Extract data for preview
                csvData = [];
                for (let i = 1; i < Math.min(6, lines.length); i++) {
                    if (lines[i].trim() !== '') {
                        const row = lines[i].split(',').map(cell => cell.trim());
                        csvData.push(row);
                    }
                }
                
                // Show preview
                showPreview();
            };
            
            reader.readAsText(file);
        }
        
        // Function to show preview of CSV data
        function showPreview() {
            let tableHTML = '<table class="preview-table">';
            
            // Add header row
            tableHTML += '<thead><tr>';
            csvHeaders.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead>';
            
            // Add data rows
            tableHTML += '<tbody>';
            csvData.forEach(row => {
                tableHTML += '<tr>';
                row.forEach(cell => {
                    tableHTML += `<td>${cell}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';
            
            tableHTML += '</table>';
            
            previewTable.innerHTML = tableHTML;
            previewContainer.style.display = 'block';
        }
        
        // Function to import data
        function importData() {
            // Show loading status
            showStatus('info', 'Importando datos', 'El proceso de importación está en curso...');
            
            // Prepare form data
            const formData = new FormData();
            formData.append('file', csvFile);
            
            // Send request to API
            fetch('/api/ventas/importar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('success', 'Importación exitosa', 
                        data.spanish_message || `Se importaron ${data.message.split(' ')[3]} registros de ventas correctamente.`);
                    
                    // Show any warnings or errors
                    if (data.errors && data.errors.length > 0) {
                        let errorHTML = '<h4>Advertencias:</h4><ul>';
                        data.errors.forEach(error => {
                            errorHTML += `<li>Artículo: ${error.articulo}, Error: ${error.error}</li>`;
                        });
                        errorHTML += '</ul>';
                        statusDetails.innerHTML = errorHTML;
                    }
                } else {
                    let errorMessage = data.error || 'Ocurrió un error durante la importación.';
                    if (data.errors) {
                        errorMessage += ' Verifica el formato del archivo.';
                    }
                    showStatus('error', 'Error de importación', errorMessage);
                    
                    // Show detailed errors if available
                    if (data.errors) {
                        let errorHTML = '<h4>Errores:</h4><ul>';
                        data.errors.forEach(error => {
                            errorHTML += `<li>Fila ${error.row}: ${error.errors.join(', ')}</li>`;
                        });
                        errorHTML += '</ul>';
                        statusDetails.innerHTML = errorHTML;
                    }
                }
            })
            .catch(error => {
                showStatus('error', 'Error de conexión', 
                    'No se pudo conectar con el servidor. Inténtalo de nuevo más tarde.');
                console.error('Error:', error);
            });
        }
        
        // Function to show status
        function showStatus(type, title, message) {
            statusTitle.textContent = title;
            statusMessage.textContent = message;
            statusDetails.innerHTML = '';
            
            statusContainer.className = 'status-container';
            statusContainer.classList.add(`status-${type}`);
            statusContainer.style.display = 'block';
        }
        
        // Function to reset UI
        function resetUI() {
            fileInput.value = '';
            csvFile = null;
            csvHeaders = [];
            csvData = [];
            
            dropZone.style.display = 'block';
            fileInfo.style.display = 'none';
            statusContainer.style.display = 'none';
            previewContainer.style.display = 'none';
        }
    });
</script>
{% endblock %} 