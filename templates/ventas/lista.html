{% extends "layout.html" %}

{% block title %}Visualización de Ventas - Inventario Zombie{% endblock %}

{% block head %}
<style>
    .filter-container {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 10px;
    }
    .filter-item {
        flex: 1;
        min-width: 200px;
    }
    .filter-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }
    .detail-modal-content {
        position: relative;
        background-color: white;
        margin: 50px auto;
        padding: 20px;
        max-width: 800px;
        border-radius: 5px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    }
    .detail-modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
    }
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .detail-item {
        margin-bottom: 10px;
    }
    .detail-label {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .receipts-by-date {
        margin-top: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .date-header {
        background-color: #f5f5f5;
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        font-weight: bold;
    }
    .date-header:hover {
        background-color: #eee;
    }
    .date-content {
        padding: 0 15px;
        display: none;
    }
    .date-content.open {
        display: block;
    }
    .receipt-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .receipt-item:last-child {
        border-bottom: none;
    }
    .variant-tag {
        display: inline-block;
        background-color: #e9f5f8;
        color: #0066cc;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.85em;
        margin-left: 8px;
    }
    .badge {
        display: inline-block;
        min-width: 10px;
        padding: 3px 7px;
        font-size: 12px;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        background-color: #777;
        border-radius: 10px;
        margin-left: 5px;
    }
    .badge-success {
        background-color: #5cb85c;
    }
    .action-links {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .action-links a {
        display: inline-block;
        padding: 6px 12px;
        text-decoration: none;
        border-radius: 4px;
        color: #fff;
    }
    .action-links a.import-receipts-link {
        background-color: #f0ad4e;
    }
    .action-links a:hover {
        opacity: 0.9;
    }
    .action-links a i {
        margin-right: 5px;
    }
    @media (max-width: 768px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
        .filter-item {
            min-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <div class="content-header">
        <h1>Visualización de Ventas</h1>
        <div class="action-links">
            <a href="{{ url_for('ventas_web.importar_recibos') }}" class="import-receipts-link">
                <i class="fas fa-receipt"></i> Importar Recibos
            </a>
        </div>
    </div>
    
    <div class="filter-container">
        <h3>Filtros</h3>
        <form id="filterForm">
            <div class="filter-row">
                <div class="filter-item">
                    <label for="fecha_inicio">Fecha inicio:</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control">
                </div>
                <div class="filter-item">
                    <label for="fecha_fin">Fecha fin:</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" class="form-control">
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-item">
                    <label for="articulo">Artículo:</label>
                    <input type="text" id="articulo" name="articulo" class="form-control" placeholder="Buscar por nombre de artículo">
                </div>
                <div class="filter-item">
                    <label for="variante">Variante:</label>
                    <input type="text" id="variante" name="subcategoria" class="form-control" placeholder="Buscar por variante">
                </div>
            </div>
            <div class="filter-actions">
                <button type="button" id="clearFiltersBtn" class="btn btn-secondary">Limpiar filtros</button>
                <button type="submit" class="btn btn-primary">Aplicar filtros</button>
            </div>
        </form>
    </div>
    
    <div id="salesContainer">
        <div class="loading" id="loadingIndicator">Cargando datos...</div>
        <div id="salesByDate">
            <!-- Filled by JavaScript -->
        </div>
        <div id="noResultsMessage" style="display: none; text-align: center; padding: 20px; margin-top: 30px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
            <i class="fas fa-info-circle" style="font-size: 24px; color: #17a2b8; margin-bottom: 10px;"></i>
            <h4>No se encontraron ventas</h4>
            <p>No hay registros de ventas en la base de datos. Puedes importar ventas usando la opción "Importar Recibos".</p>
        </div>
    </div>
    
    <div id="detailModal" class="detail-modal">
        <div class="detail-modal-content">
            <span class="detail-modal-close">&times;</span>
            <h2>Detalle de venta</h2>
            <div id="saleDetail" class="detail-grid">
                <!-- Filled by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const filterForm = document.getElementById('filterForm');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const salesContainer = document.getElementById('salesContainer');
        const salesByDate = document.getElementById('salesByDate');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noResultsMessage = document.getElementById('noResultsMessage');
        
        // Modal elements
        const detailModal = document.getElementById('detailModal');
        const detailModalClose = document.querySelector('.detail-modal-close');
        const saleDetail = document.getElementById('saleDetail');
        
        // State variables
        let salesData = [];
        let salesGrouped = {};
        
        // Initialize page
        loadSalesData();
        
        // Event listeners
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loadSalesData();
        });
        
        clearFiltersBtn.addEventListener('click', function() {
            filterForm.reset();
            loadSalesData();
        });
        
        // Modal close button
        detailModalClose.addEventListener('click', function() {
            detailModal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === detailModal) {
                detailModal.style.display = 'none';
            }
        });
        
        // Load sales data from API
        function loadSalesData() {
            showLoading(true);
            
            // Build query parameters
            const params = new URLSearchParams();
            
            // Add filters from form
            const formData = new FormData(filterForm);
            for (const [key, value] of formData.entries()) {
                if (value) {
                    params.append(key, value);
                }
            }
            
            // Fetch data from API
            fetch(`/api/ventas?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        salesData = data.data;
                        
                        // Group by date
                        salesGrouped = groupSalesByDate(salesData);
                        
                        renderSales();
                    } else {
                        showError('Error al cargar los datos de ventas.');
                    }
                    showLoading(false);
                })
                .catch(error => {
                    showError('Error en la comunicación con el servidor.');
                    console.error('Error:', error);
                    showLoading(false);
                });
        }
        
        // Group sales by date
        function groupSalesByDate(sales) {
            const grouped = {};
            
            sales.forEach(sale => {
                if (!grouped[sale.fecha]) {
                    grouped[sale.fecha] = [];
                }
                grouped[sale.fecha].push(sale);
            });
            
            return grouped;
        }
        
        // Render sales
        function renderSales() {
            // Clear container
            salesByDate.innerHTML = '';
            
            // Check if there's any data at all
            if (!salesData || salesData.length === 0 || Object.keys(salesGrouped).length === 0) {
                salesByDate.style.display = 'none';
                noResultsMessage.style.display = 'block';
                return;
            }
            
            salesByDate.style.display = 'block';
            noResultsMessage.style.display = 'none';
            
            // Sort dates in descending order
            const sortedDates = Object.keys(salesGrouped).sort().reverse();
            
            // Create date sections
            sortedDates.forEach(date => {
                const sales = salesGrouped[date];
                
                // Count total items for this date
                const totalItems = sales.reduce((sum, sale) => sum + parseInt(sale.articulos_vendidos || 0, 10), 0);
                
                // Create date header
                const dateSection = document.createElement('div');
                dateSection.className = 'receipts-by-date';
                
                const dateHeader = document.createElement('div');
                dateHeader.className = 'date-header';
                dateHeader.innerHTML = `
                    ${formatDate(date)} <span class="badge badge-success">${totalItems} artículos</span>
                `;
                
                // Create date content
                const dateContent = document.createElement('div');
                dateContent.className = 'date-content';
                
                // Group sales by articulo and subcategoria
                const groupedByProduct = {};
                sales.forEach(sale => {
                    const key = `${sale.articulo}|${sale.subcategoria || 'Sin variante'}`;
                    if (!groupedByProduct[key]) {
                        groupedByProduct[key] = {
                            articulo: sale.articulo,
                            subcategoria: sale.subcategoria || 'Sin variante',
                            cantidad: 0,
                            precio_unitario: sale.precio_unitario,
                            total: 0,
                            detalle: sale // Keep a reference to one of the sale records for detail view
                        };
                    }
                    groupedByProduct[key].cantidad += parseInt(sale.articulos_vendidos || 0, 10);
                    groupedByProduct[key].total += parseFloat(sale.total || 0);
                });
                
                // Sort by quantity sold (descending)
                const sortedProducts = Object.values(groupedByProduct).sort((a, b) => b.cantidad - a.cantidad);
                
                // Add sales items
                sortedProducts.forEach(product => {
                    const receiptItem = document.createElement('div');
                    receiptItem.className = 'receipt-item';
                    
                    // Format price if available
                    const priceHtml = product.precio_unitario > 0 
                        ? `<span class="price">${formatCurrency(product.precio_unitario)}</span>` 
                        : '';
                    
                    // Format variant
                    const variantHtml = product.subcategoria !== 'Sin variante' 
                        ? `<span class="variant-tag">${product.subcategoria}</span>` 
                        : '';
                    
                    receiptItem.innerHTML = `
                        <strong>${product.cantidad} ×</strong> ${product.articulo} ${variantHtml} ${priceHtml}
                    `;
                    
                    // Add click event to show details
                    receiptItem.addEventListener('click', () => {
                        showSaleDetail(product.detalle);
                    });
                    
                    dateContent.appendChild(receiptItem);
                });
                
                // Add click event to toggle date content
                dateHeader.addEventListener('click', () => {
                    dateContent.classList.toggle('open');
                });
                
                // Append elements
                dateSection.appendChild(dateHeader);
                dateSection.appendChild(dateContent);
                salesByDate.appendChild(dateSection);
            });
        }
        
        // Show sale detail in modal
        function showSaleDetail(sale) {
            saleDetail.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Fecha:</div>
                    <div>${formatDate(sale.fecha)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Hora:</div>
                    <div>${sale.hora}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Artículo:</div>
                    <div>${sale.articulo}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Categoría:</div>
                    <div>${sale.categoria || '-'}</div>
                </div>
                ${sale.subcategoria ? `
                <div class="detail-item">
                    <div class="detail-label">Variante:</div>
                    <div>${sale.subcategoria}</div>
                </div>
                ` : ''}
                <div class="detail-item">
                    <div class="detail-label">Cantidad:</div>
                    <div>${sale.articulos_vendidos}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Precio unitario:</div>
                    <div>${formatCurrency(sale.precio_unitario)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total:</div>
                    <div>${formatCurrency(sale.total)}</div>
                </div>
                ${sale.ticket ? `
                <div class="detail-item">
                    <div class="detail-label">Ticket:</div>
                    <div>${sale.ticket}</div>
                </div>
                ` : ''}
                ${sale.empleado ? `
                <div class="detail-item">
                    <div class="detail-label">Empleado:</div>
                    <div>${sale.empleado}</div>
                </div>
                ` : ''}
                ${sale.mesa ? `
                <div class="detail-item">
                    <div class="detail-label">Mesa:</div>
                    <div>${sale.mesa}</div>
                </div>
                ` : ''}
                ${sale.comensales ? `
                <div class="detail-item">
                    <div class="detail-label">Comensales:</div>
                    <div>${sale.comensales}</div>
                </div>
                ` : ''}
                ${sale.iva ? `
                <div class="detail-item">
                    <div class="detail-label">IVA:</div>
                    <div>${formatCurrency(sale.iva)}</div>
                </div>
                ` : ''}
                ${sale.propina ? `
                <div class="detail-item">
                    <div class="detail-label">Propina:</div>
                    <div>${formatCurrency(sale.propina)}</div>
                </div>
                ` : ''}
                ${sale.costo_estimado ? `
                <div class="detail-item">
                    <div class="detail-label">Costo estimado:</div>
                    <div>${formatCurrency(sale.costo_estimado)}</div>
                </div>
                ` : ''}
                ${sale.ganancia_estimada ? `
                <div class="detail-item">
                    <div class="detail-label">Ganancia estimada:</div>
                    <div>${formatCurrency(sale.ganancia_estimada)}</div>
                </div>
                ` : ''}
                ${sale.porcentaje_ganancia ? `
                <div class="detail-item">
                    <div class="detail-label">Porcentaje de ganancia:</div>
                    <div>${sale.porcentaje_ganancia}%</div>
                </div>
                ` : ''}
            `;
            
            detailModal.style.display = 'block';
        }
        
        // Helper function to show loading indicator
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
        }
        
        // Helper function to show error message
        function showError(message) {
            alert(message);
        }
        
        // Helper function to format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            
            try {
                const parts = dateStr.split('-');
                if (parts.length !== 3) return dateStr;
                
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            } catch (e) {
                return dateStr;
            }
        }
        
        // Helper function to format currency
        function formatCurrency(value) {
            if (value == null || value === '') return '-';
            
            try {
                const numValue = parseFloat(value);
                return numValue.toLocaleString('es-MX', {
                    style: 'currency',
                    currency: 'MXN',
                    minimumFractionDigits: 2
                });
            } catch (e) {
                return value;
            }
        }
    });
</script>
{% endblock %} 